@using System.Security.Claims
@model List<SGP_Freelancing.Models.DTOs.MessageDto>
@{
    ViewData["Title"] = "Conversation";
    Layout = "~/Views/Shared/_LayoutDashboard.cshtml";
    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    var otherUserId = ViewBag.OtherUserId as string;
    var otherUserName = Model.FirstOrDefault()?.SenderId == currentUserId 
        ? Model.FirstOrDefault()?.ReceiverName 
        : Model.FirstOrDefault()?.SenderName;
}

<div class="max-w-4xl mx-auto px-4">
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-8 py-6 rounded-t-2xl flex items-center justify-between">
        <div class="flex items-center gap-4">
            <a href="/Message" class="w-10 h-10 rounded-full bg-white/20 border-none text-white flex items-center justify-center transition-all hover:bg-white/30 hover:scale-110 cursor-pointer">
                <i class="fas fa-arrow-left"></i>
            </a>
            @if (!string.IsNullOrEmpty(otherUserName))
            {
                var initial = otherUserName[0].ToString().ToUpper();
                <div class="w-12 h-12 rounded-full bg-white/30 text-white flex items-center justify-center text-lg font-bold">@initial</div>
                <div class="flex-grow">
                    <h1 class="text-xl font-bold m-0">@otherUserName</h1>
                    <p class="text-sm opacity-90 m-0">Active</p>
                </div>
            }
        </div>
    </div>
    
    <div id="messageContainer" class="bg-white h-96 overflow-y-auto px-8 py-8 border-l border-r border-gray-200">
        @if (Model.Any())
        {
            @foreach (var message in Model.OrderBy(m => m.CreatedAt))
            {
                var isCurrentUser = message.SenderId == currentUserId;
                var senderInitial = isCurrentUser ? "Y" : (string.IsNullOrEmpty(message.SenderName) ? "?" : message.SenderName[0].ToString().ToUpper());
                
                <div class="mb-6 flex @(isCurrentUser ? "flex-row-reverse" : "flex-row") items-end">
                    <div class="@(isCurrentUser ? "bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-br-none" : "bg-gray-100 text-gray-900 rounded-bl-none") max-w-xs px-5 py-4 rounded-2xl">
                        <div class="text-xs font-bold mb-1">@(isCurrentUser ? "You" : message.SenderName)</div>
                        <p class="text-base leading-relaxed m-0 break-words">@message.Content</p>
                        <span class="text-xs @(isCurrentUser ? "text-white/70" : "text-gray-500") mt-1 block">@message.CreatedAt.ToString("hh:mm tt")</span>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="h-96 flex items-center justify-center text-center text-gray-400">
                <div>
                    <div class="text-5xl mb-4 opacity-50">
                        <i class="fas fa-comments"></i>
                    </div>
                    <p>No messages yet. Start the conversation!</p>
                </div>
            </div>
        }
    </div>
    
    <div class="bg-white px-8 py-6 rounded-b-2xl border border-t-0 border-gray-200">
        <form id="messageForm" class="flex gap-3 items-center">
            @Html.AntiForgeryToken()
            <input type="text" id="messageInput" class="flex-grow border-2 border-gray-200 rounded-full px-6 py-3 text-base focus:border-indigo-600 focus:outline-none focus:ring-4 focus:ring-indigo-100 transition-all" placeholder="Type your message..." required />
            <button type="submit" class="w-14 h-14 rounded-full bg-gradient-to-r from-indigo-600 to-blue-600 border-none text-white text-xl flex items-center justify-center transition-all hover:scale-110 hover:shadow-lg active:scale-95 flex-shrink-0">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script>
        const receiverId = '@otherUserId';
        
        // Initialize SignalR connection
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();

        connection.on("ReceiveMessage", function (senderId, senderName, message, timestamp) {
            if (senderId === receiverId) {
                appendMessage(senderName, message, timestamp, false);
                scrollToBottom();
            }
        });

        connection.start().catch(function (err) {
            console.error(err.toString());
        });

        // Handle form submission
        document.getElementById('messageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message) {
                // Send via SignalR
                connection.invoke("SendMessage", receiverId, message).catch(function (err) {
                    console.error(err.toString());
                });

                // Also save to database via API
                fetch('/Message/Send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({
                        ReceiverId: receiverId,
                        Content: message
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        appendMessage('You', message, new Date(), true);
                        messageInput.value = '';
                        scrollToBottom();
                    }
                });
            }
        });

        function appendMessage(senderName, content, timestamp, isCurrentUser) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${isCurrentUser ? 'sent' : 'received'}`;
            
            const time = new Date(timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-bubble-content">
                    <div class="message-sender">${senderName}</div>
                    <p class="message-text">${content}</p>
                    <span class="message-time">${time}</span>
                </div>
            `;
            
            container.appendChild(messageDiv);
        }

        function scrollToBottom() {
            const container = document.getElementById('messageContainer');
            container.scrollTop = container.scrollHeight;
        }

        // Scroll to bottom on page load
        scrollToBottom();
    </script>
}
